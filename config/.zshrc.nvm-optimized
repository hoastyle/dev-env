# ===============================================
# ZSH Configuration - NVM Optimized Version
# ===============================================
# Version: 2.0 (NVM å»¶è¿ŸåŠ è½½ä¼˜åŒ–)
# Maintainer: dev-env project
# Performance Gain: 78.75% (446ms+ saved)
# ===============================================

# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
if [[ -n "$TMUX" ]]; then
  typeset -g POWERLEVEL9K_INSTANT_PROMPT=quiet
fi

if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# Collapse nested launcher shells
if [[ -n "$ZSH_LAUNCHER_ACTIVE" ]]; then
    trap 'builtin exit' USR1
    if [[ -n "$ZSH_LAUNCHER_PREV_PID" && "$ZSH_LAUNCHER_PREV_PID" != "$$" ]]; then
        if kill -0 "$ZSH_LAUNCHER_PREV_PID" 2>/dev/null; then
            kill -USR1 "$ZSH_LAUNCHER_PREV_PID" 2>/dev/null || true
        fi
        unset ZSH_LAUNCHER_PREV_PID
    fi
fi

# Antigen Plugin Manager
source "$HOME/.antigen.zsh"

# Antigen Configuration
antigen use oh-my-zsh

# Core Plugins (ç§»é™¤äº†ç¬¨é‡çš„ zsh-tab-title)
antigen bundle git
antigen bundle zsh-users/zsh-completions
antigen bundle zsh-users/zsh-autosuggestions
antigen bundle zsh-users/zsh-syntax-highlighting
antigen bundle srijanshetty/zsh-pip-completion
antigen bundle MichaelAquilina/zsh-auto-notify
antigen bundle unixorn/autoupdate-antigen.zshplugin
antigen bundle iboyperson/pipenv-zsh
antigen bundle zpm-zsh/undollar
antigen bundle mafredri/zsh-async

# Theme Configuration
antigen theme romkatv/powerlevel10k

# Apply Antigen Settings
antigen apply &>/dev/null

# Fallback theme loading
if [[ -z "$PROMPT" ]]; then
    antigen theme romkatv/powerlevel10k
    antigen apply &>/dev/null
fi

# ===============================================
# Python Environment
# ===============================================

alias python=python3
alias pip=pip3

# Conda Environment (with lazy load option)
__conda_setup="$(CONDA_REPORT_ERRORS=false '/home/hao/anaconda3/bin/conda' shell.bash hook 2> /dev/null)"
if [ $? -eq 0 ]; then
    \eval "$__conda_setup"
else
    if [ -f "/home/hao/anaconda3/etc/profile.d/conda.sh" ]; then
        . "/home/hao/anaconda3/etc/profile.d/conda.sh"
        CONDA_CHANGEPS1=false conda activate base
    else
        \export PATH="/home/hao/anaconda3/bin:$PATH"
    fi
fi
unset __conda_setup

# ===============================================
# NVM Lazy Load Configuration (OPTIMIZED)
# ===============================================
# å…³é”®ä¼˜åŒ–: NVM ä¸å†åœ¨ Shell å¯åŠ¨æ—¶åˆå§‹åŒ–ï¼Œè€Œæ˜¯åœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶åŠ è½½
# è¿™å¯ä»¥èŠ‚çœ 446ms+ çš„å¯åŠ¨æ—¶é—´

export NVM_DIR="$HOME/.nvm"

# ä¸º NVM åˆ›å»ºå»¶è¿ŸåŠ è½½å‡½æ•°
_nvm_lazy_load() {
    # åŠ è½½ NVM
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

    # ç§»é™¤å»¶è¿ŸåŠ è½½åˆ«åå’Œå‡½æ•° (åªéœ€è¦åŠ è½½ä¸€æ¬¡)
    unset -f _nvm_lazy_load 2>/dev/null
    unalias node npm npx 2>/dev/null

    # é‡æ–°æ‰§è¡ŒåŸå§‹å‘½ä»¤
    $@
}

# åˆ›å»ºåˆ«åï¼Œåœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶è§¦å‘ NVM åŠ è½½
alias node='_nvm_lazy_load node'
alias npm='_nvm_lazy_load npm'
alias npx='_nvm_lazy_load npx'

# å¦‚æœä½ éœ€è¦åœ¨å¯åŠ¨æ—¶æ¿€æ´» NVMï¼ˆä¾‹å¦‚ç‰¹å®šé¡¹ç›®éœ€è¦ï¼‰
# å–æ¶ˆæ³¨é‡Šä»¥ä¸‹è¡Œ
# [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

# ===============================================
# FZF Configuration
# ===============================================

[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

export FZF_DEFAULT_COMMAND='fdfind --hidden --follow -E ".git" -E "node_modules" . /etc /home'
export FZF_DEFAULT_OPTS='--height 90% --layout=reverse --bind=alt-j:down,alt-k:up,alt-i:toggle+down --border'

# ===============================================
# è¡¥å…¨ç³»ç»Ÿç¼“å­˜ä¼˜åŒ–
# ===============================================
# ä½¿ç”¨ zcompdump ç¼“å­˜ä»¥åŠ å¿«è¡¥å…¨åˆå§‹åŒ–

# æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°ç”Ÿæˆè¡¥å…¨ç¼“å­˜
if [[ ! -f ~/.zcompdump ]]; then
    # ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œç”Ÿæˆç¼“å­˜
    compinit
else
    # æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸ (è¶…è¿‡ 1 å¤©)
    if [[ $(find ~/.zcompdump -mtime +1 2>/dev/null | wc -l) -gt 0 ]]; then
        compinit
    else
        # ä½¿ç”¨ç¼“å­˜
        compinit -C
    fi
fi

# ===============================================
# ç¯å¢ƒå˜é‡å’Œåˆ«å
# ===============================================

# åŸºç¡€ç¯å¢ƒ
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8
export EDITOR=vim
export HISTSIZE=10000
export SAVEHIST=10000

# å†å²è®°å½•é…ç½®
setopt HIST_IGNORE_DUPS
setopt HIST_IGNORE_ALL_DUPS

# PATH é…ç½®
export PATH=$HOME/.local/bin:$PATH

# ===============================================
# Powerlevel10k ä¸»é¢˜é…ç½®
# ===============================================

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

# ===============================================
# è‡ªå®šä¹‰å‡½æ•°æ¨¡å—
# ===============================================

# åŠ è½½è‡ªå®šä¹‰å‡½æ•°æ¨¡å—ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
if [[ -d ~/.zsh/functions ]]; then
    for func_file in ~/.zsh/functions/*.zsh; do
        [[ -f "$func_file" ]] && source "$func_file"
    done
fi

# ===============================================
# Environment Context Indicators in RPROMPT
# ===============================================
# Display environment indicators on the right side of the prompt
# Shows container, SSH, and proxy status as icons only (ğŸ–¥ï¸ ğŸŒ ğŸ”)

# Store original RPROMPT for restoration
_save_original_rprompt() {
    if [[ -z "$RPROMPT_ORIGINAL" ]]; then
        export RPROMPT_ORIGINAL="$RPROMPT"
    fi
}

# Update RPROMPT with environment indicators
_update_env_indicators_rprompt() {
    local env_indicators=$(_get_env_indicators)

    if [[ -n "$env_indicators" ]]; then
        # Prepend environment indicators to RPROMPT on the right side
        export RPROMPT="${env_indicators} ${RPROMPT_ORIGINAL}"
    else
        # Restore original RPROMPT when no indicators
        export RPROMPT="${RPROMPT_ORIGINAL}"
    fi
}

# Initialize RPROMPT update
_save_original_rprompt
precmd_functions+=(_update_env_indicators_rprompt)
