# ===============================================
# ZSH Configuration - NVM Optimized Version
# ===============================================
# Version: 2.0 (NVM Âª∂ËøüÂä†ËΩΩ‰ºòÂåñ)
# Maintainer: dev-env project
# Performance Gain: 78.75% (446ms+ saved)
# ===============================================

# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
if [[ -n "$TMUX" ]]; then
  typeset -g POWERLEVEL9K_INSTANT_PROMPT=quiet
fi

if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# Collapse nested launcher shells
if [[ -n "$ZSH_LAUNCHER_ACTIVE" ]]; then
    trap 'builtin exit' USR1
    if [[ -n "$ZSH_LAUNCHER_PREV_PID" && "$ZSH_LAUNCHER_PREV_PID" != "$$" ]]; then
        if kill -0 "$ZSH_LAUNCHER_PREV_PID" 2>/dev/null; then
            kill -USR1 "$ZSH_LAUNCHER_PREV_PID" 2>/dev/null || true
        fi
        unset ZSH_LAUNCHER_PREV_PID
    fi
fi

# Antigen Plugin Manager
source "$HOME/.antigen.zsh"

# Antigen Configuration
antigen use oh-my-zsh

# Core Plugins (ÁßªÈô§‰∫ÜÁ¨®ÈáçÁöÑ zsh-tab-title)
antigen bundle git
antigen bundle zsh-users/zsh-completions
antigen bundle zsh-users/zsh-autosuggestions
antigen bundle zsh-users/zsh-syntax-highlighting
antigen bundle srijanshetty/zsh-pip-completion
antigen bundle MichaelAquilina/zsh-auto-notify
antigen bundle unixorn/autoupdate-antigen.zshplugin
antigen bundle iboyperson/pipenv-zsh
antigen bundle zpm-zsh/undollar
antigen bundle mafredri/zsh-async

# Theme Configuration
antigen theme romkatv/powerlevel10k

# Apply Antigen Settings
antigen apply &>/dev/null

# Fallback theme loading
if [[ -z "$PROMPT" ]]; then
    antigen theme romkatv/powerlevel10k
    antigen apply &>/dev/null
fi

# ===============================================
# Python Environment
# ===============================================

alias python=python3
alias pip=pip3

# Conda Environment (with lazy load option)
__conda_setup="$(CONDA_REPORT_ERRORS=false "$HOME/anaconda3/bin/conda" shell.bash hook 2> /dev/null)"
if [ $? -eq 0 ]; then
    \eval "$__conda_setup"
else
    if [ -f "$HOME/anaconda3/etc/profile.d/conda.sh" ]; then
        . "$HOME/anaconda3/etc/profile.d/conda.sh"
        CONDA_CHANGEPS1=false conda activate base
    else
        \export PATH="$HOME/anaconda3/bin:$PATH"
    fi
fi
unset __conda_setup

# ===============================================
# NVM Lazy Load Configuration (OPTIMIZED)
# ===============================================
# ÂÖ≥ÈîÆ‰ºòÂåñ: NVM ‰∏çÂÜçÂú® Shell ÂêØÂä®Êó∂ÂàùÂßãÂåñÔºåËÄåÊòØÂú®Á¨¨‰∏ÄÊ¨°‰ΩøÁî®Êó∂Âä†ËΩΩ
# ËøôÂèØ‰ª•ËäÇÁúÅ 446ms+ ÁöÑÂêØÂä®Êó∂Èó¥

export NVM_DIR="$HOME/.nvm"

# ‰∏∫ NVM ÂàõÂª∫Âª∂ËøüÂä†ËΩΩÂáΩÊï∞
_nvm_lazy_load() {
    # Âä†ËΩΩ NVM
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

    # ÁßªÈô§Âª∂ËøüÂä†ËΩΩÂà´ÂêçÂíåÂáΩÊï∞ (Âè™ÈúÄË¶ÅÂä†ËΩΩ‰∏ÄÊ¨°)
    unset -f _nvm_lazy_load 2>/dev/null
    unalias node npm npx 2>/dev/null

    # ÈáçÊñ∞ÊâßË°åÂéüÂßãÂëΩ‰ª§
    $@
}

# ÂàõÂª∫Âà´ÂêçÔºåÂú®Á¨¨‰∏ÄÊ¨°‰ΩøÁî®Êó∂Ëß¶Âèë NVM Âä†ËΩΩ
alias node='_nvm_lazy_load node'
alias npm='_nvm_lazy_load npm'
alias npx='_nvm_lazy_load npx'

# Â¶ÇÊûú‰Ω†ÈúÄË¶ÅÂú®ÂêØÂä®Êó∂ÊøÄÊ¥ª NVMÔºà‰æãÂ¶ÇÁâπÂÆöÈ°πÁõÆÈúÄË¶ÅÔºâ
# ÂèñÊ∂àÊ≥®Èáä‰ª•‰∏ãË°å
# [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

# ===============================================
# FZF Configuration
# ===============================================

[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

export FZF_DEFAULT_COMMAND='fdfind --hidden --follow -E ".git" -E "node_modules" . /etc /home'
export FZF_DEFAULT_OPTS='--height 90% --layout=reverse --bind=alt-j:down,alt-k:up,alt-i:toggle+down --border'

# ===============================================
# Ë°•ÂÖ®Á≥ªÁªüÁºìÂ≠ò‰ºòÂåñ
# ===============================================
# ‰ΩøÁî® zcompdump ÁºìÂ≠ò‰ª•Âä†Âø´Ë°•ÂÖ®ÂàùÂßãÂåñ

# Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÈáçÊñ∞ÁîüÊàêË°•ÂÖ®ÁºìÂ≠ò
if [[ ! -f ~/.zcompdump ]]; then
    # Á¨¨‰∏ÄÊ¨°ËøêË°åÔºåÁîüÊàêÁºìÂ≠ò
    compinit
else
    # Ê£ÄÊü•ÁºìÂ≠òÊòØÂê¶ËøáÊúü (Ë∂ÖËøá 1 Â§©)
    if [[ $(find ~/.zcompdump -mtime +1 2>/dev/null | wc -l) -gt 0 ]]; then
        compinit
    else
        # ‰ΩøÁî®ÁºìÂ≠ò
        compinit -C
    fi
fi

# ===============================================
# ZSH Completion Configuration
# ===============================================

# Case-insensitive Tab completion (safe and convenient)
# This makes Tab completion ignore case for file names and commands
# Example: "cd doc<Tab>" will match "Documents", "downloads", "DOCS"
# Note: Wildcards (*.jpg) remain case-sensitive to avoid accidental file operations
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}'

# ===============================================
# ÁéØÂ¢ÉÂèòÈáèÂíåÂà´Âêç
# ===============================================

# Âü∫Á°ÄÁéØÂ¢É
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8
export EDITOR=vim
export HISTSIZE=10000
export SAVEHIST=10000

# ÂéÜÂè≤ËÆ∞ÂΩïÈÖçÁΩÆ
setopt HIST_IGNORE_DUPS
setopt HIST_IGNORE_ALL_DUPS

# PATH ÈÖçÁΩÆ
export PATH=$HOME/.local/bin:$PATH

# ===============================================
# Custom Functions
# ===============================================

# Load custom functions from ~/.zsh/functions
if [[ -d "$HOME/.zsh/functions" ]]; then
    for function_file in "$HOME/.zsh/functions"/*.zsh; do
        if [[ -f "$function_file" ]]; then
            source "$function_file"
        fi
    done
fi

# ===============================================
# Powerlevel10k ‰∏ªÈ¢òÈÖçÁΩÆ
# ===============================================

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

# ===============================================
# Environment Context Indicators
# ===============================================
# Environment indicators are loaded from ~/.zsh/functions/context.zsh
# and integrated into Powerlevel10k via the prompt_env_indicators segment
#
# To enable: Run: ./scripts/setup-p10k-env-indicators.sh
# Or manually edit ~/.p10k.zsh and add 'env_indicators' to RIGHT_PROMPT_ELEMENTS
#
# See: docs/P10K_ENV_INDICATORS_SETUP.md for detailed setup instructions

# ===============================================
# Configuration Complete
# ===============================================

# Welcome message disabled to support Powerlevel10k instant prompt
# The theme provides its own visual feedback
# To re-enable, uncomment the following line:
# echo "üéâ Development Environment ZSH Configuration Loaded"

# ===============================================
# User-Local Binary PATH (~/.local/bin)
# ===============================================
# Add ~/.local/bin to PATH for user-installed tools (e.g., uv, pipx, etc.)
# This script uses intelligent PATH management to avoid duplicate entries
# Source: uv installer and XDG Base Directory Specification
if [[ -f "$HOME/.local/bin/env" ]]; then
    source "$HOME/.local/bin/env"
fi
