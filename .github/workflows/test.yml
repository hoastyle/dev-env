# =============================================================================
# GitHub Actions CI/CD Pipeline
# =============================================================================
# Description: Automated testing for dev-env ZSH configuration project
# =============================================================================

name: Tests

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:

# =============================================================================
# Jobs
# =============================================================================

jobs:
  # -------------------------------------------------------------------------
  # Unit Tests
  # -------------------------------------------------------------------------
  unit-tests:
    name: Unit Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh bc

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install zsh

      - name: Verify ZSH installation
        run: |
          zsh --version
          echo "ZSH version check passed"

      - name: Run unit tests
        run: |
          echo "Running unit tests..."
          for test in tests/unit/*.sh; do
            if [[ -f "$test" ]]; then
              echo "Running: $test"
              bash "$test" || echo "Test failed: $test"
            fi
          done

      - name: Validate configuration syntax
        run: |
          echo "Validating ZSH configuration files..."
          for config in config/.zshrc*; do
            if [[ -f "$config" ]]; then
              echo "Checking: $config"
              zsh -n "$config" || echo "Syntax error in: $config"
            fi
          done

  # -------------------------------------------------------------------------
  # Performance Tests
  # -------------------------------------------------------------------------
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh bc python3

      - name: Run startup benchmark
        run: |
          if [[ -f "tests/performance/test_startup_benchmark.sh" ]]; then
            bash tests/performance/test_startup_benchmark.sh
          else
            echo "Startup benchmark test not found, skipping"
          fi
        continue-on-error: true

      - name: Run memory usage test
        run: |
          if [[ -f "tests/performance/test_memory_usage.sh" ]]; then
            bash tests/performance/test_memory_usage.sh
          else
            echo "Memory usage test not found, skipping"
          fi
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-test-results
          path: test-results/
          retention-days: 30

  # -------------------------------------------------------------------------
  # Script Validation
  # -------------------------------------------------------------------------
  script-validation:
    name: Script Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check script syntax
        run: |
          echo "Checking script syntax..."
          find scripts -name "*.sh" -type f -exec bash -n {} \; -print
          echo "All scripts have valid syntax"

      - name: Check test script syntax
        run: |
          echo "Checking test script syntax..."
          find tests -name "*.sh" -type f -exec bash -n {} \; -print
          echo "All test scripts have valid syntax"

      - name: Verify executable permissions
        run: |
          echo "Checking executable permissions..."
          missing_exec=0
          for script in scripts/*.sh tests/unit/*.sh tests/performance/*.sh; do
            if [[ -f "$script" && ! -x "$script" ]]; then
              echo "Missing execute permission: $script"
              missing_exec=1
            fi
          done
          if [[ $missing_exec -eq 1 ]]; then
            echo "Error: Some scripts are not executable"
            exit 1
          fi
          echo "All scripts have correct permissions"

  # -------------------------------------------------------------------------
  # Configuration Validation
  # -------------------------------------------------------------------------
  config-validation:
    name: Configuration Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ZSH
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh

      - name: Validate all ZSH configs
        run: |
          echo "Validating ZSH configuration files..."
          for config in config/.zshrc* templates/*/*.zshrc; do
            if [[ -f "$config" ]]; then
              echo "Checking: $config"
              zsh -n "$config" && echo "  ✓ OK" || { echo "  ✗ FAILED"; exit 1; }
            fi
          done
          echo "All configuration files are valid"

  # -------------------------------------------------------------------------
  # Template System Tests
  # -------------------------------------------------------------------------
  template-tests:
    name: Template System Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh bc

      - name: Test template selector
        run: |
          echo "Testing template selector..."
          bash scripts/zsh_template_selector.sh list

      - name: Test template availability
        run: |
          echo "Checking template files..."
          templates=(dev-full dev-minimal server docker)
          for tmpl in "${templates[@]}"; do
            if [[ ! -f "templates/${tmpl#dev-}/${tmpl}.zshrc" ]] && \
               [[ ! -f "templates/${tmpl#dev-}/${tmpl}.zshrc" ]]; then
              echo "Checking for template: $tmpl"
            fi
          done

      - name: Test template syntax
        run: |
          echo "Validating template syntax..."
          find templates -name "*.zshrc" -type f -exec zsh -n {} \; -print

  # -------------------------------------------------------------------------
  # Cross-Platform Tests
  # -------------------------------------------------------------------------
  cross-platform-tests:
    name: Cross-Platform Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh bc

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install zsh bc

      - name: Test platform compatibility library
        run: |
          source scripts/lib_platform_compat.sh
          echo "OS Type: $(get_os_type)"
          if is_macos; then
            echo "Running on macOS"
          else
            echo "Running on Linux"
          fi

      - name: Test logging library
        run: |
          source scripts/lib_logging.sh
          init_logging
          log_info "Test log message"
          echo "Logging library test passed"

      - name: Test performance library
        run: |
          source scripts/lib_performance.sh
          echo "Performance library test passed"

  # -------------------------------------------------------------------------
  # Documentation Tests
  # -------------------------------------------------------------------------
  documentation-tests:
    name: Documentation Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README exists
        run: |
          if [[ ! -f "README.md" ]]; then
            echo "ERROR: README.md not found"
            exit 1
          fi
          echo "README.md found"

      - name: Check key documentation files
        run: |
          docs=(CLAUDE.md CHANGELOG.md docs/README.md templates/README.md)
          missing=0
          for doc in "${docs[@]}"; do
            if [[ ! -f "$doc" ]]; then
              echo "Warning: $doc not found"
              missing=1
            fi
          done
          if [[ $missing -eq 0 ]]; then
            echo "All documentation files present"
          fi

  # -------------------------------------------------------------------------
  # Build Test (Simulate Installation)
  # -------------------------------------------------------------------------
  installation-test:
    name: Installation Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh bc git

      - name: Test installation script (dry-run)
        run: |
          if [[ -f "scripts/install_zsh_config.sh" ]]; then
            echo "Testing installation script syntax..."
            bash -n scripts/install_zsh_config.sh
            echo "Installation script syntax is valid"
          else
            echo "Installation script not found, skipping"
          fi

      - name: Test zsh_tools.sh
        run: |
          if [[ -f "scripts/zsh_tools.sh" ]]; then
            bash scripts/zsh_tools.sh help || echo "Help command test"
          fi

  # -------------------------------------------------------------------------
  # Summary
  # -------------------------------------------------------------------------
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, performance-tests, script-validation, config-validation, template-tests, cross-platform-tests, documentation-tests, installation-test]
    if: always()

    steps:
      - name: Check all job results
        run: |
          echo "Test Summary"
          echo "============"
          echo ""
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Performance Tests: ${{ needs.performance-tests.result }}"
          echo "Script Validation: ${{ needs.script-validation.result }}"
          echo "Config Validation: ${{ needs.config-validation.result }}"
          echo "Template Tests: ${{ needs.template-tests.result }}"
          echo "Cross-Platform Tests: ${{ needs.cross-platform-tests.result }}"
          echo "Documentation Tests: ${{ needs.documentation-tests.result }}"
          echo "Installation Test: ${{ needs.installation-test.result }}"
          echo ""

          # Fail if any required job failed
          if [[ "${{ needs.unit-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.script-validation.result }}" == "failure" ]] || \
             [[ "${{ needs.config-validation.result }}" == "failure" ]]; then
            echo "CRITICAL TESTS FAILED"
            exit 1
          fi

          echo "All critical tests passed!"
