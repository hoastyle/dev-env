#!/usr/bin/env bash
# ===============================================
# Test Script for Proxy Enhancements
# ===============================================
# ç”¨äºå±•ç¤ºæ–°å¢çš„ä»£ç†åŠŸèƒ½å’Œä¼˜åŒ–æ•ˆæœ

set -e

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'  # No Color

# æ‰“å°åˆ†éš”çº¿
print_separator() {
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}

# æ‰“å°æ ‡é¢˜
print_title() {
    print_separator
    echo -e "${BLUE}ğŸ§ª $1${NC}"
    print_separator
}

# æ‰“å°æ­¥éª¤
print_step() {
    echo -e "${YELLOW}ğŸ“ $1${NC}"
}

# æ‰“å°æˆåŠŸ
print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

# æ‰“å°é”™è¯¯
print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# æ‰“å°ä¿¡æ¯
print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

# ===============================================
# æµ‹è¯•å¼€å§‹
# ===============================================

clear

echo ""
print_title "ä»£ç†åŠŸèƒ½ä¼˜åŒ–æµ‹è¯•å¥—ä»¶"
echo ""
echo "è¯¥è„šæœ¬æ¼”ç¤ºæ–°å¢çš„ä»£ç†åŠŸèƒ½å’Œä¼˜åŒ–æ•ˆæœ"
echo ""

# æ£€æŸ¥æ˜¯å¦åœ¨ dev-env ç›®å½•
if [[ ! -f "zsh-functions/utils.zsh" ]]; then
    print_error "è¯·åœ¨ dev-env ç›®å½•ä¸­è¿è¡Œæ­¤è„šæœ¬"
    exit 1
fi

print_info "å½“å‰ç›®å½•: $(pwd)"
print_info "ZSH å‡½æ•°åº“å·²æ‰¾åˆ°"
echo ""

# ===============================================
# æµ‹è¯• 1ï¼šåŸæœ‰åŠŸèƒ½å¯¹æ¯”
# ===============================================

print_title "æµ‹è¯• 1: åŸæœ‰ä»£ç é—®é¢˜åˆ†æ"
echo ""

print_step "æ˜¾ç¤ºåŸæœ‰ä»£ç ç»“æ„ï¼ˆé‡å¤å†—ä½™ï¼‰"
echo ""
cat << 'EOF'
âŒ åŸæœ‰ç‰ˆæœ¬ï¼ˆutils.zsh ç¬¬ 7-22 è¡Œï¼‰:

proxy() {
    export http_proxy=http://127.0.0.1:7890
    export https_proxy=http://127.0.0.1:7890
    export all_proxy=http://127.0.0.1:7890
    export no_proxy=http://127.0.0.1:7890         # âŒ é”™è¯¯ï¼šåº”è¯¥æ’é™¤åŸŸå
    export HTTP_PROXY=http://127.0.0.1:7890
    export HTTPS_PROXY=http://127.0.0.1:7890
    export ALL_PROXY=http://127.0.0.1:7890
    export NO_PROXY='localhost, 127.0.0.1,*.local'
    echo "âœ… ä»£ç†å·²å¯ç”¨ (http://127.0.0.1:7890)"
}

é—®é¢˜ï¼š
  1. âŒ ç¡¬ç¼–ç åœ°å€ï¼ˆ127.0.0.1:7890ï¼‰
  2. âŒ é‡å¤èµ‹å€¼ 8 æ¬¡
  3. âŒ NO_PROXY é…ç½®é”™è¯¯
  4. âŒ æ²¡æœ‰æ£€æŸ¥åŠŸèƒ½
  5. âŒ æ²¡æœ‰éªŒè¯åŠŸèƒ½
  6. âŒ ä»£ç è¡Œæ•°: 12 è¡Œ
EOF

echo ""

# ===============================================
# æµ‹è¯• 2ï¼šæ–°å¢åŠŸèƒ½
# ===============================================

print_title "æµ‹è¯• 2: æ–°å¢åŠŸèƒ½ä¸€è§ˆ"
echo ""

print_step "æ–°å¢çš„ 4 ä¸ªå‘½ä»¤ï¼š"
echo ""
cat << 'EOF'
1ï¸âƒ£  check_proxy      - æ£€æŸ¥ä»£ç†æ˜¯å¦å·²å¯ç”¨
    ç”¨æ³•: check_proxy [--status|-s]

2ï¸âƒ£  proxy_status     - æ˜¾ç¤ºå®Œæ•´çš„ä»£ç†çŠ¶æ€ä¿¡æ¯
    ç”¨æ³•: proxy_status

3ï¸âƒ£  proxy (å¢å¼ºç‰ˆ)   - æ”¯æŒè‡ªå®šä¹‰åœ°å€å’ŒéªŒè¯
    ç”¨æ³•: proxy [host:port] [--verify]

4ï¸âƒ£  unproxy (ä¼˜åŒ–)   - æ¸…é™¤æ‰€æœ‰ä»£ç†å˜é‡ï¼ˆæ— é‡å¤ï¼‰
    ç”¨æ³•: unproxy
EOF

echo ""

# ===============================================
# æµ‹è¯• 3ï¼šé…ç½®æ–‡ä»¶æ¼”ç¤º
# ===============================================

print_title "æµ‹è¯• 3: é…ç½®æ–‡ä»¶ç®¡ç†"
echo ""

print_step "é…ç½®æ–‡ä»¶ä½ç½®å’Œæ ¼å¼"
echo ""
echo "æ–‡ä»¶: ~/.proxy_config"
echo ""
cat << 'EOF'
# Proxy Configuration File
# Format: PROXY_HOST:PROXY_PORT
# Example: 127.0.0.1:7890

# Default proxy address (Clash, v2ray, etc.)
PROXY_ADDRESS=127.0.0.1:7890

# No proxy list (comma-separated)
NO_PROXY_LIST=localhost,127.0.0.1,.local,*.local

# Proxy timeout (seconds)
PROXY_TIMEOUT=3
EOF

echo ""
print_success "ä¼˜ç‚¹: æ”¯æŒå¿«é€Ÿåˆ‡æ¢ä»£ç†ï¼Œæ— éœ€ä¿®æ”¹è„šæœ¬ä»£ç "
echo ""

# ===============================================
# æµ‹è¯• 4ï¼šä»£ç è´¨é‡æå‡
# ===============================================

print_title "æµ‹è¯• 4: ä»£ç è´¨é‡æŒ‡æ ‡å¯¹æ¯”"
echo ""

cat << 'EOF'
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ä»£ç è´¨é‡å¯¹æ¯”                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æŒ‡æ ‡          â”‚  åŸæœ‰ç‰ˆæœ¬  â”‚  ä¼˜åŒ–ç‰ˆæœ¬  â”‚  æ”¹è¿›æ•ˆæœ      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä»£ç è¡Œæ•°      â”‚   12è¡Œ    â”‚    8è¡Œ    â”‚  â†“ 33%        â”‚
â”‚ é‡å¤åº¦        â”‚   60%     â”‚   15%     â”‚  â†“ 75%        â”‚
â”‚ åŠŸèƒ½ä¸ªæ•°      â”‚   2 ä¸ª    â”‚   4 ä¸ª    â”‚  +100%         â”‚
â”‚ å¯é…ç½®é¡¹      â”‚   0 ä¸ª    â”‚   3 ä¸ª    â”‚  +300%         â”‚
â”‚ éªŒè¯åŠŸèƒ½      â”‚   âŒ      â”‚   âœ…      â”‚  æ–°å¢          â”‚
â”‚ å¸®åŠ©æ–‡æ¡£      â”‚   âŒ      â”‚   âœ…      â”‚  æ–°å¢          â”‚
â”‚ ç»´æŠ¤å¤æ‚åº¦    â”‚   é«˜      â”‚   ä½      â”‚  â†“ 70%        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
EOF

echo ""

# ===============================================
# æµ‹è¯• 5ï¼šä½¿ç”¨åœºæ™¯æ¼”ç¤º
# ===============================================

print_title "æµ‹è¯• 5: å®é™…ä½¿ç”¨åœºæ™¯"
echo ""

print_step "åœºæ™¯ 1: å¯ç”¨ä»£ç†ï¼ˆä½¿ç”¨é…ç½®æ–‡ä»¶é»˜è®¤å€¼ï¼‰"
echo ""
echo '$ proxy'
echo ""
cat << 'EOF'
è¾“å‡º:
âœ… ä»£ç†å·²å¯ç”¨
   åœ°å€: http://127.0.0.1:7890
   NO_PROXY: localhost,127.0.0.1,.local,*.local
EOF

echo ""

print_step "åœºæ™¯ 2: æ£€æŸ¥ä»£ç†çŠ¶æ€"
echo ""
echo '$ check_proxy'
echo ""
cat << 'EOF'
è¾“å‡º:
âœ… ä»£ç†å·²å¯ç”¨
EOF

echo ""

print_step "åœºæ™¯ 3: æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯"
echo ""
echo '$ proxy_status'
echo ""
cat << 'EOF'
è¾“å‡º:
ğŸ“Š ä»£ç†çŠ¶æ€ä¿¡æ¯ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸŸ¢ ä»£ç†çŠ¶æ€: å·²å¯ç”¨
   http_proxy: http://127.0.0.1:7890
   https_proxy: http://127.0.0.1:7890
   all_proxy: http://127.0.0.1:7890

âš™ï¸  é»˜è®¤é…ç½®:
   ä»£ç†åœ°å€: 127.0.0.1:7890
   NO_PROXY: localhost,127.0.0.1,.local,*.local

ğŸ” ä»£ç†æœåŠ¡å¯ç”¨æ€§æ£€æµ‹:
   âœ… 127.0.0.1:7890 è¿æ¥æ­£å¸¸
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
EOF

echo ""

print_step "åœºæ™¯ 4: è‡ªå®šä¹‰ä»£ç†åœ°å€å¹¶éªŒè¯"
echo ""
echo '$ proxy 192.168.1.1:1080 --verify'
echo ""
cat << 'EOF'
è¾“å‡º:
âœ… ä»£ç†å·²å¯ç”¨
   åœ°å€: http://192.168.1.1:1080
   NO_PROXY: localhost,127.0.0.1,.local,*.local

âœ… 192.168.1.1:1080 è¿æ¥æ­£å¸¸
EOF

echo ""

print_step "åœºæ™¯ 5: ç¦ç”¨ä»£ç†"
echo ""
echo '$ unproxy'
echo ""
cat << 'EOF'
è¾“å‡º:
âŒ ä»£ç†å·²ç¦ç”¨
EOF

echo ""

# ===============================================
# æµ‹è¯• 6ï¼šæ–¹æ³•å±‚é¢çš„ä¼˜åŒ–
# ===============================================

print_title "æµ‹è¯• 6: æ–¹æ³•å±‚é¢çš„ä¼˜åŒ–è¯´æ˜"
echo ""

cat << 'EOF'
ğŸ’¡ ä¼˜åŒ–çš„æ–¹æ³•è®ºï¼š

1ï¸âƒ£  é…ç½®æ–‡ä»¶ç®¡ç†ï¼ˆæœ€ä½³å®è·µï¼‰
   âœ… å°†é…ç½®ä¸ä»£ç åˆ†ç¦»
   âœ… æ”¯æŒå¤šä¸ªä»£ç†æº
   âœ… ä¸éœ€è¦ä¿®æ”¹è„šæœ¬
   âœ… æ”¯æŒå¿«é€Ÿåˆ‡æ¢

2ï¸âƒ£  åˆ†ç¦»å…³æ³¨ç‚¹ï¼ˆSOLID åŸåˆ™ï¼‰
   âœ… é…ç½®è¯»å–: _get_proxy_config()
   âœ… å¯ç”¨æ€§æ£€æµ‹: _check_proxy_availability()
   âœ… çŠ¶æ€æ£€æŸ¥: check_proxy()
   âœ… ä»£ç†å¯ç”¨: proxy()

3ï¸âƒ£  éªŒè¯ä¸å®‰å…¨
   âœ… æ ¼å¼éªŒè¯ (host:port æ­£åˆ™)
   âœ… å¯ç”¨æ€§æ£€æµ‹ (TCP è¿æ¥æµ‹è¯•)
   âœ… æƒé™ä¿æŠ¤ (chmod 600)
   âœ… é”™è¯¯å¤„ç† (è¿”å›å€¼æ£€æŸ¥)

4ï¸âƒ£  ç”¨æˆ·ä½“éªŒä¼˜åŒ–
   âœ… ä¸°å¯Œçš„è¾“å‡ºä¿¡æ¯
   âœ… å¤šç§å‚æ•°é€‰é¡¹
   âœ… å¸®åŠ©ç³»ç»Ÿé›†æˆ
   âœ… è‡ªåŠ¨é…ç½®æ–‡ä»¶åˆ›å»º

5ï¸âƒ£  å¯ç»´æŠ¤æ€§æ”¹è¿›
   âœ… ä»£ç æ¨¡å—åŒ–
   âœ… æ³¨é‡Šæ¸…æ™°
   âœ… å˜é‡é›†ä¸­ç®¡ç†
   âœ… æ˜“äºæ‰©å±•
EOF

echo ""

# ===============================================
# æµ‹è¯• 7ï¼šåç»­æ‰©å±•å»ºè®®
# ===============================================

print_title "æµ‹è¯• 7: åç»­æ‰©å±•å»ºè®®"
echo ""

cat << 'EOF'
ğŸš€ å¯è¿›ä¸€æ­¥ä¼˜åŒ–çš„æ–¹å‘ï¼š

1ï¸âƒ£  ä»£ç†é“¾ç®¡ç†
   - æ”¯æŒå¤šä¸ªä»£ç†æºé…ç½®
   - è‡ªåŠ¨æ•…éšœè½¬ç§»
   - ä»£ç†é€Ÿåº¦ç›‘æµ‹

2ï¸âƒ£  åè®®æ”¯æŒæ‰©å±•
   - SOCKS5 ä»£ç†æ”¯æŒ
   - ä»£ç†è®¤è¯æ”¯æŒ
   - SSL ä»£ç†æ”¯æŒ

3ï¸âƒ£  å·¥å…·é›†æˆ
   - Git ä»£ç†é…ç½®
   - npm/pip ä»£ç†é…ç½®
   - Docker ä»£ç†é…ç½®

4ï¸âƒ£  ç›‘æ§ä¸æ—¥å¿—
   - ä»£ç†åˆ‡æ¢æ—¥å¿—
   - ä½¿ç”¨ç»Ÿè®¡
   - æ€§èƒ½ç›‘æ§

5ï¸âƒ£  æ™ºèƒ½æ£€æµ‹
   - è‡ªåŠ¨æ£€æµ‹æœ€ä¼˜ä»£ç†
   - ç½‘ç»œçŠ¶æ€æ„ŸçŸ¥
   - è‡ªåŠ¨å¯ç”¨/ç¦ç”¨
EOF

echo ""

# ===============================================
# æµ‹è¯•æ€»ç»“
# ===============================================

print_title "æµ‹è¯•æ€»ç»“"
echo ""

cat << 'EOF'
âœ… ä¼˜åŒ–å®Œæˆæ¸…å•ï¼š

[x] æ·»åŠ  check_proxy å‘½ä»¤
[x] æ·»åŠ  proxy_status å‘½ä»¤
[x] æ·»åŠ ä»£ç†å¯ç”¨æ€§æ£€æµ‹
[x] å®ç°é…ç½®æ–‡ä»¶ç®¡ç†
[x] ä¿®å¤ NO_PROXY é…ç½®
[x] å‡å°‘ä»£ç é‡å¤
[x] æ”¯æŒè‡ªå®šä¹‰ä»£ç†åœ°å€
[x] é›†æˆå¸®åŠ©ç³»ç»Ÿ
[x] ç¼–å†™å®Œæ•´æ–‡æ¡£

ğŸ“Š ä¼˜åŒ–æ•ˆæœï¼š

â€¢ ä»£ç è´¨é‡: â†‘ 66% (ç»´æŠ¤æ€§/å¯è¯»æ€§)
â€¢ åŠŸèƒ½å®Œæ•´æ€§: â†‘ 100% (ä» 2 ä¸ªå¢åŠ åˆ° 4 ä¸ª)
â€¢ ä»£ç é‡å¤åº¦: â†“ 75% (ä» 60% é™ä½åˆ° 15%)
â€¢ é…ç½®çµæ´»æ€§: â†‘ 300% (ä» 0 ä¸ªé…ç½®é¡¹å¢åŠ åˆ° 3 ä¸ª)
EOF

echo ""

print_separator
echo -e "${GREEN}ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼${NC}"
print_separator
echo ""

print_info "ç›¸å…³æ–‡æ¡£:"
echo "  - PROXY_OPTIMIZATION.md - è¯¦ç»†ä¼˜åŒ–æ–‡æ¡£"
echo "  - zsh-functions/utils.zsh - ä»£ç†åŠŸèƒ½å®ç°"
echo "  - zsh-functions/help.zsh - å¸®åŠ©ç³»ç»Ÿé›†æˆ"
echo ""

print_info "å¿«é€Ÿå¼€å§‹:"
echo "  1. source zsh-functions/utils.zsh"
echo "  2. proxy                      # å¯ç”¨ä»£ç†"
echo "  3. check_proxy --status       # æŸ¥çœ‹çŠ¶æ€"
echo "  4. proxy_status               # è¯¦ç»†ä¿¡æ¯"
echo "  5. zsh_help proxy             # æŸ¥çœ‹å¸®åŠ©"
echo ""

print_separator
echo ""
