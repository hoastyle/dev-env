entity: lib_migration.run_migrations
stability: stable
version: "2.3.0"
description: æ‰§è¡Œæ‰€æœ‰å¾…å¤„ç†çš„é…ç½®è¿ç§»

inputs:
  - name: dry_run
    type: bool
    description: æ˜¯å¦ä¸ºå¹²è¿è¡Œæ¨¡å¼ï¼ˆä¸å®é™…æ‰§è¡Œè¿ç§»ï¼‰
    required: false
    default: false
    constraints:
      - type: boolean

  - name: force
    type: bool
    description: å¼ºåˆ¶æ‰§è¡Œè¿ç§»ï¼Œè·³è¿‡å¥åº·æ£€æŸ¥
    required: false
    default: false
    constraints:
      - type: boolean

outputs:
  type: migration_result
  description: è¿ç§»æ‰§è¡Œç»“æœ
  fields:
    - name: executed_count
      type: int
      description: æˆåŠŸæ‰§è¡Œçš„è¿ç§»æ•°é‡

    - name: failed_count
      type: int
      description: å¤±è´¥çš„è¿ç§»æ•°é‡

    - name: pending_count
      type: int
      description: ä»æœªæ‰§è¡Œçš„è¿ç§»æ•°é‡

    - name: return_code
      type: exitcode
      description: 0=å…¨éƒ¨æˆåŠŸ, 1=éƒ¨åˆ†å¤±è´¥, 2=å…¨éƒ¨å¤±è´¥

errors:
  - code: MIGRATION_NOT_FOUND
    condition: è¿ç§»è„šæœ¬æ–‡ä»¶ä¸å­˜åœ¨
    message: "Migration script not found: {migration_file}"
    retryable: false

  - code: MIGRATION_FAILED
    condition: è¿ç§»è„šæœ¬æ‰§è¡Œå¤±è´¥
    message: "Migration {migration_id} failed with exit code {exit_code}"
    retryable: false

  - code: HEALTH_CHECK_FAILED
    condition: æ‰§è¡Œå‰å¥åº·æ£€æŸ¥å¤±è´¥
    message: "Pre-migration health check failed"
    retryable: true

  - code: VERSION_UPDATE_FAILED
    condition: æ›´æ–°ç‰ˆæœ¬è®°å½•å¤±è´¥
    message: "Failed to update version after migration"
    retryable: true

side_effects:
  - description: æ‰§è¡Œè¿ç§»è„šæœ¬ï¼ˆå¯èƒ½ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼‰
    risk: medium

  - description: æ›´æ–°è¿ç§»å†å²è®°å½•
    risk: low

  - description: æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
    risk: low

  - description: åˆ›å»ºå¤‡ä»½ï¼ˆå¦‚æœè¿ç§»æ”¯æŒï¼‰
    risk: low

examples:
  - description: æ­£å¸¸æ‰§è¡Œæ‰€æœ‰å¾…å¤„ç†è¿ç§»
    input:
      dry_run: false
    output:
      executed_count: 2
      failed_count: 0
      pending_count: 0
      return_code: 0
      message: "âœ… Executed 2 migrations successfully"

  - description: å¹²è¿è¡Œæ¨¡å¼
    input:
      dry_run: true
    output:
      executed_count: 0
      pending_count: 2
      return_code: 0
      message: "ğŸ” Would execute 2 migrations: 001_initial, 002_add_template_system"

  - description: éƒ¨åˆ†è¿ç§»å¤±è´¥
    input:
      dry_run: false
    output:
      executed_count: 1
      failed_count: 1
      pending_count: 0
      return_code: 1
      message: "âš ï¸ Migration 002_add_template_system failed"

dependencies:
  required:
    - lib_version
    - lib_logging
    - MIGRATIONS_DIR directory
    - MIGRATION_HISTORY log file
  optional:
    - lib_backup (ç”¨äºè¿ç§»å‰å¤‡ä»½)

implementation_notes: |
  æ‰§è¡Œæµç¨‹ï¼š
  1. è·å–å½“å‰ç‰ˆæœ¬ (get_current_version)
  2. è·å–å¾…å¤„ç†è¿ç§»åˆ—è¡¨ (get_pending_migrations)
  3. å¯¹äºå¹²è¿è¡Œæ¨¡å¼ï¼Œåªæ˜¾ç¤ºå°†è¦æ‰§è¡Œçš„è¿ç§»
  4. å¯¹äºå®é™…æ‰§è¡Œï¼š
     a. å¯é€‰ï¼šæ‰§è¡Œå¥åº·æ£€æŸ¥
     b. å¯é€‰ï¼šåˆ›å»ºå¤‡ä»½
     c. æŒ‰é¡ºåºæ‰§è¡Œæ¯ä¸ªè¿ç§»
     d. è®°å½•è¿ç§»å†å²
     e. æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
  5. è¿”å›æ‰§è¡Œç»“æœç»Ÿè®¡

  è¿ç§»è„šæœ¬å‘½åçº¦å®šï¼šXXX_description.sh
  - XXX: ä¸‰ä½æ•°å­—åºå·ï¼ˆå¦‚ 001, 002ï¼‰
  - description: ç®€çŸ­æè¿°ï¼ˆå°å†™+ä¸‹åˆ’çº¿ï¼‰

  æ¯ä¸ªè¿ç§»è„šæœ¬éœ€è¦å®šä¹‰ï¼š
  - migrate_up(): æ‰§è¡Œè¿ç§»
  - migrate_down(): å›æ»šè¿ç§»ï¼ˆå¯é€‰ï¼‰
  - DESCRIPTION: è¿ç§»æè¿°

  é”™è¯¯å¤„ç†ç­–ç•¥ï¼š
  - å•ä¸ªè¿ç§»å¤±è´¥ï¼šåœæ­¢æ‰§è¡Œåç»­è¿ç§»
  - å·²æ‰§è¡Œçš„è¿ç§»è®°å½•åœ¨å†å²ä¸­
  - ç”¨æˆ·éœ€è¦æ‰‹åŠ¨ä¿®å¤æˆ–å›æ»š
